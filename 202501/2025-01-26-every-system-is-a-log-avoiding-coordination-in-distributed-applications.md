# Every System is a Log: Avoiding coordination in distributed applications
- URL: https://restate.dev/blog/every-system-is-a-log-avoiding-coordination-in-distributed-applications/
- Added At: 2025-01-26 06:01:38
- [Link To Text](2025-01-26-every-system-is-a-log-avoiding-coordination-in-distributed-applications_raw.md)

## TL;DR
文章探讨了通过避免分布式协调来简化分布式应用设计的方法，核心思想是将所有系统操作写入同一个日志（上游日志），以确保一致性和可靠性。这种方法减少了复杂性，提高了效率，并简化了操作。Restate是实现这一思想的工具，支持有状态处理程序和虚拟对象，适用于需要可靠执行的关键功能应用。未来计划包括发布分布式Restate和进一步探讨日志设计。

## Summary
1. **分布式应用的挑战**：
   - 构建弹性的分布式应用仍然是一个巨大的挑战。
   - 开发者需要花费大量时间处理故障转移策略、重试机制、竞态条件、锁/栅栏、操作顺序、变更的可见性等问题。
   - 许多应用在故障或高负载下无法正确处理这些问题。

2. **核心思想**：通过避免分布式协调来简化分布式应用的设计。
   - 许多问题的解决方案可以追溯到Apache Flink的开发经验。
   - 分布式应用和基础设施的核心观察是：**每个系统都是一个日志**。

3. **日志的普遍性**：
   - **消息队列**是日志：如Apache Kafka、Pulsar、Meta的Scribe等。
   - **数据库**是日志：变更首先写入预写日志（WAL），然后物化到表中。
   - **分布式锁和领导者选举服务**是日志：如ZooKeeper、Etcd等，核心是共识日志。
   - **持久状态机**物化其状态转换的日志。

4. **应用中的日志协调**：
   - 应用通常需要协调多个日志，例如数据库、消息队列和服务API。
   - 示例：实现一个`processPayment`处理程序，涉及欺诈检测、账户余额更新、状态存储和通知发送。
   - 问题：并发调用、失败后的重试、非确定性欺诈模型等可能导致不一致。

5. **改进方案**：
   - 将所有系统的操作写入同一个日志（上游日志）。
   - 每次处理程序想要更改其他系统的状态时，向上游日志写入一条记录。
   - 重试时，日志会附带所有链接的记录（执行日志），确保操作的一致性。

6. **条件追加**：
   - 使用条件追加来确保只有在没有更新的重试时才能追加日志条目。
   - 这种方法可以避免并发重试导致的步骤历史损坏，提供强大的工作流执行保证。

7. **锁和状态管理**：
   - 处理程序将锁获取、释放和状态更新事件写入上游日志。
   - 锁服务和数据库遵循上游日志，确保锁的获取和释放以及状态更新的一致性。
   - 这种方法消除了锁和状态管理中的许多问题和边缘情况。

8. **协调避免的优势**：
   - 通过将所有状态集中在一个日志中，避免了分布式协调的复杂性。
   - 这种方法减少了工作量，提高了效率，减少了边缘情况，简化了操作。

9. **实际应用**：
   - **Restate**是实现这一思想的工具，它拥有上游日志并确保处理程序的可靠重试。
   - Restate使用双向流协议（如HTTP/2）来调用事件处理程序并发送日志事件和确认。
   - Restate支持有状态的处理程序，这些处理程序可以锁定一个键并在重试期间保持锁定。

10. **虚拟对象**：
    - Restate支持将处理程序分组以共享状态，称为**虚拟对象**。
    - 虚拟对象的状态在键值存储中无限保留，即使日志事件最终被垃圾回收。

11. **其他构建块**：
    - Restate还支持**持久化Futures/Promises**、**定时器**和**幂等键**等构建块。
    - 这些构建块都基于相同的概念：通过同一个日志路由事件，存储在日志中，并处理到数据库或调度器中。

12. **应用场景**：
    - 这种方法适用于需要创建有状态、可靠和可恢复执行的关键功能的应用。
    - 单日志方法通过单一依赖项和无需跨队列、数据库、锁和调度器的协调来提供这些功能。

13. **分离关注点**：
    - 在分布式多服务架构中，不应为每个操作使用单一日志。
    - Restate的目标是驱动所有严格限定在处理程序或服务范围内的状态，并通过日志传输服务之间的消息。

14. **数据库与日志的状态**：
    - Restate不会取代通用数据库，共享数据库仍然是基础设施的一部分。
    - 日志上的键值状态非常适合状态机、临时状态或任何通过事件驱动处理程序更新的状态。

15. **未来计划**：
    - Restate是开源的，用户可以下载并尝试这种模式。
    - 未来将发布分布式Restate，支持复制、扩展部署和对象存储快照。
    - 未来文章将探讨日志的设计、为什么选择开发新类型的日志以及其独特之处。
