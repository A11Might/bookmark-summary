# How rqlite is tested – Vallified
- URL: https://philipotoole.com/how-is-rqlite-tested/
- Added At: 2025-01-15 00:14:00
- [Link To Text](2025-01-15-how-rqlite-is-tested-–-vallified_raw.md)

## TL;DR
rqlite是一个基于SQLite和Raft的分布式关系数据库，自2014年开发以来，始终以可靠性和质量为优先。其测试策略遵循测试金字塔模型，强调单元测试、集成测试和少量端到端测试，确保高效性和针对性。单元测试覆盖广泛，系统级和端到端测试提供全面覆盖，性能测试评估极限负载下的表现。rqlite通过小处着手、有目的性测试和持续优化，保持高质量和快速迭代，测试实践将继续演进，保持简单性。

## Summary
1. **rqlite简介**：
   - rqlite是一个轻量级、开源的分布式关系数据库，基于SQLite和Raft构建。
   - 自2014年开发以来，其设计始终优先考虑可靠性和质量。
   - 经过10多年的开发和部署，用户报告的生产环境中panic实例少于10次。

2. **测试策略**：
   - rqlite的测试策略遵循测试金字塔模型，强调单元测试、集成测试和少量的端到端测试。
   - 这种策略确保了测试套件的高效性、针对性和易调试性。

3. **单元测试**：
   - 单元测试是rqlite测试套件的核心，覆盖了隔离的组件。
   - rqlite的单元测试代码量约为27,000行，占整个代码库的很大一部分。
   - 单元测试速度快，可以在几分钟内完成，支持开发过程中的频繁测试。

4. **系统级测试**：
   - 系统级测试关注Raft共识模块与SQLite之间的交互。
   - 测试内容包括SQLite语句的复制、不同一致性级别的读操作、集群中断时的恢复等。
   - 系统级测试代码量约为7,000行，提供了全面的覆盖。

5. **端到端测试**：
   - 端到端测试作为烟雾测试，验证系统启动、集群和基本操作。
   - 端到端测试代码量约为5,000行，采用有针对性的方法，避免过度依赖。

6. **性能测试**：
   - 性能测试评估rqlite在负载下的极限，包括最大INSERT速率、并发查询处理、内存和磁盘使用等。
   - 测试中使用超过2GB的大型SQLite数据库，以识别内存管理或磁盘写入延迟等瓶颈。

7. **经验教训**：
   - **从小处着手**：单元测试是建立系统信心的最有效方式。
   - **有目的性**：在更高层次添加测试必须有正当理由。
   - **适应和迭代**：性能测试揭示了fsync调用是主要瓶颈，导致进一步优化磁盘使用。
   - **效率重要**：测试套件在几分钟内运行，支持快速迭代。

8. **质量优先**：
   - 通过遵循测试金字塔和专注于有针对性的高效测试，rqlite在保持高质量的同时最小化开销。
   - 随着rqlite的不断发展，其测试实践也将继续演进，保持测试的简单性是其设计哲学的基石。
