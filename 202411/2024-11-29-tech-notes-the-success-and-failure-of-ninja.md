# Tech Notes: The Success and Failure of Ninja
- URL: https://neugierig.org/software/blog/2020/05/ninja.html
- Added At: 2024-11-29 00:24:06
- [Link To Text](2024-11-29-tech-notes-the-success-and-failure-of-ninja_raw.md)

## TL;DR
Ninja是一个高效的构建系统，由作者在2011年发布，现广泛应用于Chrome、Android等大型项目。其设计注重速度和性能，通过并行执行命令和优化文件处理提升构建效率。Ninja的成功得益于与CMake的集成和跨平台支持，作者通过回顾总结了编程中的社会因素和技术细节。

## Summary
1. **Ninja简介**：Ninja是一个类似于Make的构建系统，由作者在九年前发布。尽管最初作者对分享这个副项目感到尴尬，但它后来变得非常流行，被Chrome、Android、Meson项目、Swift编程语言等大型项目使用。

2. **项目成功与维护**：Ninja是作者最成功的开源项目之一。作者在2011年发布Ninja，2014年将项目所有权交给他人，之后又转交给第三位维护者。现在作者的角色基本结束，希望通过回顾总结学到的经验。

3. **编程与社会因素**：作者总结道，编程不仅仅是写代码，代码的重要性不如架构，而架构的重要性不如社会因素。技术问题几乎总是次要于更大的因素。

4. **技术细节**：
   - **功能概述**：Ninja的功能相对简单，用户提供一个`ninja.build`文件，包含所有命令及其输入输出文件。Ninja加载文件，检查文件修改时间，并并行执行必要的命令。
   - **核心功能**：包括解析和解释构建文件、检查输入文件的修改时间、执行命令。目标是尽快进入执行阶段，尤其是在处理大量文件时。
   - **优化细节**：例如，Ninja会尽早将每个输入文件路径映射到唯一的内存对象，并使用指针比较路径相等性。

5. **架构设计**：
   - **图表示**：Ninja使用文件和命令之间的二分图，更好地捕捉构建结构。
   - **依赖日志**：为了正确处理C头文件依赖，Ninja需要消费C编译器生成的额外依赖数据。
   - **端到端/崩溃唯一**：Ninja不是持久守护进程，每次执行都从头开始，这基于端到端原则和崩溃唯一软件的理念。
   - **文件状态**：Ninja在单线程中处理文件状态，因为Linux内核已经缓存了这些信息。
   - **规模与优化**：通过优化可以获得2倍的性能提升，但要获得10倍的性能提升需要重新架构。
   - **欠规范与过规范**：Ninja并行执行命令，要求用户提供足够信息，但也允许不完整的信息。

6. **汇编器隐喻**：Ninja的洞察是所有构建系统最终都必须构建某种动作图，Ninja只实现这个动作图，并让用户选择顶层的“生成器”程序。

7. **默认值的重要性**：Ninja默认并行执行命令，这使得它通常比Make更快，因为Make默认串行执行。

8. **速度与性能**：Ninja主要关注大型代码库中的增量构建性能，作者认为迭代时间对程序员满意度有很大影响。

9. **CMake集成**：Ninja最初为Chrome的特殊构建系统设计，后来被Peter Collingbourne集成到更流行的CMake系统中，这对Ninja的成功至关重要。

10. **Windows支持**：由于Chrome也面向Windows，Ninja也支持Windows，尽管在技术上支持Windows是一个大麻烦。

11. **相关工作与研究**：作者提到在设计Ninja时没有充分研究相关工作，现在认识到理解设计空间的重要性。

12. **开源维护**：作者分享了作为开源维护者的感受，包括偶尔的自豪感和更大的失望感。

13. **最终感谢**：作者感谢了Nico Weber和Jan Niklas Hasse等贡献者，以及所有Ninja的作者。
