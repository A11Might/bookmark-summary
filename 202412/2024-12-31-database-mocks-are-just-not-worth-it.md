# Database mocks are just not worth it
- URL: https://www.shayon.dev/post/2024/365/database-mocks-are-just-not-worth-it/
- Added At: 2024-12-31 00:11:17
- [Link To Text](2024-12-31-database-mocks-are-just-not-worth-it_raw.md)

## TL;DR
真实数据库测试比模拟测试更能揭示潜在问题，如数据完整性、性能瓶颈和并发问题，尤其在验证复杂数据关系和业务逻辑时更为重要。模拟测试则适用于高层编排和外部服务交互，确保测试专注性。两者结合使用，能更全面地保障应用程序的稳定性和可靠性。

## Summary
1. **数据库模拟的局限性**：
   - **表面优势**：数据库模拟（mocks）在测试中速度更快且看似更直接。
   - **隐藏问题**：模拟无法揭示应用程序成熟后可能出现的潜在问题，如唯一约束冲突、默认值处理或性能瓶颈。

2. **真实数据库测试的重要性**：
   - **示例对比**：
     - **模拟方法**：通过模拟用户创建过程，无法验证数据完整性或约束。
     - **真实数据库方法**：通过真实数据库测试，可以提前发现数据完整性问题、默认值处理和索引问题，减少调试时间并降低生产环境中的风险。

3. **测试的未来保障**：
   - **新特性与模式变更**：真实数据库测试能够捕捉到新验证、数据类型修改或时间戳精度变化引发的错误。
   - **示例测试**：通过真实数据库测试订单创建和状态跟踪，确保代码与实际模式的一致性。

4. **维护真实的数据库状态**：
   - **并发与隔离问题**：真实数据库测试能够暴露并发、隔离和聚合问题，确保事务处理和聚合计算的准确性。
   - **示例测试**：通过真实数据库测试账户余额计算，确保事务处理和余额计算的准确性。

5. **测试中的服务边界理解**：
   - **多层应用测试**：应用程序通常包含控制器、服务、存储库和外部服务集成等多个层次，每个层次应专注于其职责。
   - **示例测试**：
     - **服务层**：通过真实数据库测试订单创建，确保数据库状态正确。
     - **控制器层**：通过模拟服务调用，专注于参数处理和响应，确保测试的专注性。

6. **测试策略与分层职责**：
   - **数据访问层**：真实数据库测试对于验证外键、引用完整性和数据库事务至关重要。
   - **服务层**：真实数据库测试揭示业务逻辑与数据的交互。
   - **控制器层**：通过模拟服务调用，专注于参数处理和响应，确保测试的专注性。
   - **用例或交互层**：可以模拟任何低层服务，便于定位逻辑错误，减少对外部系统或数据库的依赖。

7. **真实数据库测试与模拟的平衡**：
   - **真实数据库测试的适用场景**：适用于存储库方法、复杂数据关系和性能敏感场景。
   - **模拟的适用场景**：适用于验证高层编排和外部服务交互，控制器可以专注于输入输出数据，无需担心数据库操作或第三方调用的复杂性。
