# Fine! I'll Play With Skiplists
- URL: https://buttondown.com/jaffray/archive/fine-ill-play-with-skiplists/
- Added At: 2024-12-02 00:30:57
- [Link To Text](2024-12-02-fine!-i'll-play-with-skiplists_raw.md)

## TL;DR
LSM树是一种高效的存储引擎数据结构，通过memtable和sstable实现数据管理。跳表作为memtable的核心数据结构，支持快速读写和有序扫描，但实现复杂。未来研究将聚焦于跳表优化和其他数据结构的探索。

## Summary
1. **LSM树简介**：
   - LSM树（Log-Structured Merge tree）是一种流行的存储引擎数据结构，广泛应用于RocksDB等数据库中。
   - LSM树通过将新写入的数据添加到内存中的索引（memtable）和持久化文件（WAL）来工作，memtable用于查询服务，WAL提供持久性。
   - 当memtable过大时，会将其刷新到磁盘上的不可变索引文件（sstable），释放memtable和WAL的空间。

2. **LSM树的简化表达**：
   - 作者认为LSM树比磁盘上的B树更简单，因为它们更具组合性且大部分数据是不可变的，除了memtable外，并发处理相对容易。
   - 然而，LSM树的调优较为复杂，因为有许多移动部件。

3. **memtable的实现挑战**：
   - memtable需要支持快速读取、并发写入和长寿命迭代器，这排除了粗粒度锁的使用。
   - 需要支持有序扫描以构建sstable，排除了哈希表的使用。
   - 写入需要线性化，排除了线程本地未排序缓冲区的使用。

4. **数据结构选择**：
   - 由于memtable的插入仅操作，不涉及删除，这简化了跳表的实现。
   - 数据库通常需要限制内存使用，常见的做法是分配两个memtable，当一个满时，将其设为只读并开始刷新到磁盘，同时切换到第二个memtable。

5. **跳表的详细解释**：
   - 跳表是一个带有多个快捷链表的链表，每个快捷链表的元素数量少于前一个。
   - 通过随机选择元素来决定每个级别的包含内容，避免了多写者之间的协调。
   - 查找操作从最高级别开始，找到目标键所在的级别后，逐级下降直到找到底层。

6. **并发写入的实现**：
   - LevelDB的跳表是单写者多读者，而RocksDB和Pebble的跳表支持多写者多读者。
   - 多写者场景下，插入操作需要使用比较并交换（CAS）来确保并发写入的正确性。

7. **跳表的高度优化**：
   - Pebble代码中提到最优的`p`值为1/e，作者通过模拟验证了这一观点。
   - 不同数量的元素和最大高度会影响最优`p`值的选择。

8. **未来工作**：
   - 作者计划进一步研究跳表的优化，包括使用梯度下降法加速模拟过程。
   - 对其他数据结构如写时复制B树也感兴趣，但这是未来的研究方向。
